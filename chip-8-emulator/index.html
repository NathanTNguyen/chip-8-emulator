<!-- To serve: emrun --no_browser --port 8080 . -->
<!-- keep tailwind updated: npx tailwindcss -i ./styles.css -o ./output.css --watch-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHIP-8 Emulator</title>
    <script src="chip8.js"></script>
    <link href="output.css" rel="stylesheet" />
  </head>

  <body class="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-top pt-12">
    <h1 class="text-3xl font-bold mb-6">CHIP-8 Emulator</h1>

    <!-- Emulator Canvas -->
    <canvas
      id="chip8Canvas"
      width="640"
      height="320"
      class="border-4 border-white bg-black image-rendering-pixelated"
    ></canvas>

    <!-- Controls -->
    <div class="mt-6 flex flex-col sm:flex-row items-center gap-4">
      <input type="file" id="romUploader" class="px-3 py-2 border border-gray-300 rounded bg-gray-100 text-gray-900" />
      <button
        onclick="startEmulator()"
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition"
      >
        Start
      </button>
      <button
        onclick="stopEmulator()"
        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition"
      >
        Stop
      </button>
    </div>

    <script>
      let running = false;
      let animationFrameId;
      let stepTimeoutId;

      Module.onRuntimeInitialized = function () {
        console.log("WASM Loaded!");

        window.startEmulator = function () {
          if (running) return;
          console.log("Emulator started!");
          running = true;

          function render() {
            if (!running) return;
            let displayBuffer = Module._getDisplay();
            let offscreenCanvas = document.createElement("canvas");
            offscreenCanvas.width = 64;
            offscreenCanvas.height = 32;
            let offscreenCtx = offscreenCanvas.getContext("2d");
            let imageData = offscreenCtx.createImageData(64, 32);

            for (let i = 0; i < 64 * 32; i++) {
              let color = Module.getValue(displayBuffer + i, "i8") ? 255 : 0;
              imageData.data[i * 4] = color;
              imageData.data[i * 4 + 1] = color;
              imageData.data[i * 4 + 2] = color;
              imageData.data[i * 4 + 3] = 255;
            }

            offscreenCtx.putImageData(imageData, 0, 0);
            let canvas = document.getElementById("chip8Canvas");
            let ctx = canvas.getContext("2d");
            ctx.imageSmoothingEnabled = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(offscreenCanvas, 0, 0, 64, 32, 0, 0, canvas.width, canvas.height);
            animationFrameId = requestAnimationFrame(render);
          }

          function step() {
            if (!running) return;
            Module._emulateCycle();
            render();
            stepTimeoutId = setTimeout(step, 200);
          }
          step();
        };

        window.stopEmulator = function () {
          console.log("Emulator stopped!");
          running = false;
          clearTimeout(stepTimeoutId);
          cancelAnimationFrame(animationFrameId);
        };
      };

      document.getElementById("romUploader").addEventListener("change", function (event) {
        let file = event.target.files[0];
        if (file) {
          let reader = new FileReader();
          reader.onload = function (e) {
            console.log("ROM Loaded:", file.name);
            let romData = new Uint8Array(e.target.result);

            if (typeof Module._malloc === "undefined") {
              console.error("ERROR: _malloc is undefined!");
              return;
            }

            let ptr = Module._malloc(romData.length);
            Module.HEAPU8.set(romData, ptr);
            Module._loadROM(ptr, romData.length);
            Module._free(ptr);
          };
          reader.readAsArrayBuffer(file);
        }
      });
    </script>
  </body>
</html>
